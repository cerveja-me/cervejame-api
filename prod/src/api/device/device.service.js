'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.insertDevice=insertDevice;exports.deviceAssignment=deviceAssignment;var _db=require('../../db/db');var _db2=_interopRequireDefault(_db);var _pgPromise=require('pg-promise');var _errorHandler=require('../../handlers/errorHandler');var _errorHandler2=_interopRequireDefault(_errorHandler);var _httpStatus=require('http-status');var _httpStatus2=_interopRequireDefault(_httpStatus);var _device=require('./device.query');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}async function insertDevice(device){try{const findDevice=new _pgPromise.PreparedStatement('find-device',_device.FIND_DEVICE);findDevice.values=[device.device_uuid,device.app_name,device.install_uuid];let dev=await _db2.default.one(findDevice);const updateDevice=new _pgPromise.PreparedStatement('update-device',_device.UPDATE_DEVICE);updateDevice.values=[device.push_token,device.app_version,dev.id];dev=await _db2.default.one(updateDevice);console.log('device -> ',dev);return dev}catch(error){try{const insertDev=new _pgPromise.PreparedStatement('insert-device',_device.CREATE_DEVICE);insertDev.values=[device.push_token,device.app_version,device.app_name,device.app_os,device.phone_model,device.device_uuid,device.install_uuid];let dev=await _db2.default.one(insertDev);console.log('inserido -> ',dev);return dev}catch(error){throw new _errorHandler2.default(`Erro ao tentar cadastrar o perfil. Detalhe(s): ${error.detail}`,_httpStatus2.default.BAD_REQUEST,true,error.code)}}}async function deviceAssignment(profile,deviceId){try{const findDeviceByID=new _pgPromise.PreparedStatement('find-device-by-id',_device.FIND_DEVICE_BY_ID);findDeviceByID.values=[deviceId];let dev=await _db2.default.one(findDeviceByID);if(dev.app_name===2&&profile.type!==3){throw new _errorHandler2.default(`Usuário e/ou senha inválidos`,_httpStatus2.default.BAD_REQUEST,true,1002)}else{const updateProfileDevice=new _pgPromise.PreparedStatement('update-profile-device',_device.UPDATE_PROFILE_ID_ON_DEVICE);updateProfileDevice.values=[profile.id,deviceId];await _db2.default.oneOrNone(updateProfileDevice);return true}}catch(error){throw error}}